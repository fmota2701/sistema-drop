<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <!-- üîπ PARTE 1: Cabe√ßalho com Firebase e estilo -->
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sistema de Drop</title>

<style>
  body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 20px; }
  .box { background: white; padding: 20px; border-radius: 8px; max-width: 600px; margin: auto; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
  h2 { color: #333; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #eee; }
</style>

</head>
<body>
  <!-- üîπ PARTE 2: Interface visual (Login, Admin, Evento, Fila, Sorteio) -->
   <!-- Login Jogador -->
<div class="box" id="login-box">
  <h2>Login do Jogador</h2>
  <form id="login-form">
    <input type="text" id="nick-login" placeholder="Nick" required />
    <button type="submit">Entrar</button>
  </form>
</div>

<!-- Painel Jogador Atualizado -->
<div class="box" id="jogador-box" style="display:none;">
  <h2>Bem-vindo, <span id="nick-exibido"></span></h2>

  <h3>Itens Dispon√≠veis</h3>
  <div id="itens-disponiveis">
    <!-- Lista de itens que o jogador pode selecionar -->
  </div>

  <button id="participar-btn" disabled>Participar do Sorteio</button>
  <p id="mensagem-participacao"></p>

  <h3>Hist√≥rico de Sorteios</h3>
  <ul id="historico-jogador"></ul>
</div>


<!-- Login Admin -->
<div class="box" id="admin-login">
  <h2>Admin Login</h2>
  <form id="admin-form">
    <input type="password" id="senha-admin" placeholder="Senha" required />
    <button type="submit">Entrar Admin</button>
  </form>
</div>

<!-- Painel Admin -->
<div class="box" id="admin-panel" style="display:none;">
  <h2>Admin Painel</h2>
  <h3>Cadastrar Jogador</h3>
  <form id="cadastro-jogador-form">
  <input type="text" id="nick" placeholder="Nick" required />
  <input type="text" id="classe" placeholder="Classe" required />
  <input type="number" id="cp" placeholder="CP (ex: 34000000)" required />
  <input type="number" id="nivel" placeholder="N√≠vel" required />
  <button type="submit">Cadastrar Jogador</button>
</form>
<p id="mensagem-jogador"></p>

  <h3>Jogadores Cadastrados</h3>
  <ul id="lista-jogadores"></ul>

  <h3>Cadastrar Item</h3>
  <form id="cadastro-item-form">
    <input type="text" id="item-nome" placeholder="Item" required />
    <input type="number" id="item-cp" placeholder="CP M√≠nimo" required />
    <input type="number" id="item-nivel" placeholder="N√≠vel M√≠nimo" required />
    <button type="submit">Cadastrar Item</button>
  </form>

  <h3>Itens Cadastrados</h3>
  <ul id="lista-itens"></ul>

  <h3>Criar Evento</h3>
  <form id="evento-form">
    <input type="text" id="boss-nome" placeholder="Boss" required />
    <input type="datetime-local" id="evento-horario" required />
    <button type="submit">Criar Evento</button>
  </form>
</div>

<!-- Painel Evento -->
<div class="box" id="evento-box" style="display:none;">
  <h2>Evento: <span id="evento-nome"></span></h2>
  <p>Hor√°rio: <span id="evento-horario-texto"></span></p>

  <h3>Fila de Jogadores</h3>
  <form id="fila-form">
    <input type="text" id="nick-fila" placeholder="Nick" required />
    <button type="submit">Adicionar</button>
  </form>

  <table>
    <thead><tr><th>Ordem</th><th>Nick</th><th>Faltas</th></tr></thead>
    <tbody id="tabela-fila"></tbody>
  </table>

  <button id="sortear">Sortear</button>
  <p id="vencedor"></p>

  <h3>Hist√≥rico</h3>
  <ul id="historico"></ul>
</div>


  <!-- üîπ PARTE 3: Script funcional -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, doc, setDoc, getDoc, addDoc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCXB6lJFAVcBNQ5VFp0Pbr-wuZbEp5m4AQ",
  authDomain: "caraquinhas-drop.firebaseapp.com",
  projectId: "caraquinhas-drop",
  storageBucket: "caraquinhas-drop.appspot.com",
  messagingSenderId: "102170747527",
  appId: "1:102170747527:web:a21c2bbd0fcefd31684e22"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// üëá Continue aqui com seu c√≥digo...

async function listarJogadores() {
  const lista = document.getElementById("lista-jogadores");
  lista.innerHTML = "";
  const snap = await getDocs(collection(db, "jogadores"));
  snap.forEach(docSnap => {
    const j = docSnap.data();
    const li = document.createElement("li");
    li.textContent = `${docSnap.id} - Classe: ${j.classe}, CP: ${formatarCP(j.cp)}, Nivel: ${j.nivel}`;
    lista.appendChild(li);
  });
}

// Elementos HTML
const loginForm = document.getElementById("login-form");
const jogadorBox = document.getElementById("jogador-box");
const nickExibido = document.getElementById("nick-exibido");
const adminForm = document.getElementById("admin-form");
const adminPanel = document.getElementById("admin-panel");

const cadastroJogadorForm = document.getElementById("cadastro-jogador-form");
const cadastroItemForm = document.getElementById("cadastro-item-form");

const eventoForm = document.getElementById("evento-form");
const eventoBox = document.getElementById("evento-box");
const eventoNomeSpan = document.getElementById("evento-nome");
const eventoHorarioTexto = document.getElementById("evento-horario-texto");

const filaForm = document.getElementById("fila-form");
const tabelaFila = document.getElementById("tabela-fila");
const sortearBtn = document.getElementById("sortear");
const vencedorP = document.getElementById("vencedor");
const historico = document.getElementById("historico");

let eventoId = "";
let fila = [];

// Login Jogador
loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const nick = document.getElementById("nick-login").value.trim();
  const docRef = doc(db, "jogadores", nick);
  const snap = await getDoc(docRef);

  if (snap.exists()) {
    loginForm.parentElement.style.display = "none";
    jogadorBox.style.display = "block";
    nickExibido.textContent = nick;
    mostrarItensElegiveis(nick, snap.data());
    carregarHistoricoJogador(nick);
  } else {
    alert("Jogador n√£o cadastrado.");
  }
});

// Login Admin
adminForm.addEventListener("submit", (e) => {
  e.preventDefault();
  const senha = document.getElementById("senha-admin").value;
  if (senha === "f3l1p3") {
    adminPanel.style.display = "block";
    adminForm.parentElement.style.display = "none";
  } else {
    alert("Senha incorreta!");
  }
});

// Cadastro Jogador
cadastroJogadorForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const nick = document.getElementById("nick").value.trim();
  const classe = document.getElementById("classe").value.trim();
  const cp = parseInt(document.getElementById("cp").value);
  const nivel = parseInt(document.getElementById("nivel").value);

  try {
    await setDoc(doc(db, "jogadores", nick), { classe, cp, nivel });
    document.getElementById("mensagem-jogador").textContent = "‚úÖ Jogador cadastrado com sucesso!";
    cadastroJogadorForm.reset();
    
    try {
      await listarJogadores();  // tentativa separada
    } catch (listError) {
      console.warn("Erro ao listar jogadores (n√£o afeta cadastro):", listError);
    }

  } catch (error) {
    document.getElementById("mensagem-jogador").textContent = "‚ùå Erro ao cadastrar jogador.";
    console.error("Erro ao cadastrar jogador:", error);
  }
});


// Cadastro Item
cadastroItemForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const nome = document.getElementById("item-nome").value.trim();
  const cpMin = parseInt(document.getElementById("item-cp").value);
  const nivelMin = parseInt(document.getElementById("item-nivel").value);

  try {
    await setDoc(doc(db, "itens", nome), { cpMin, nivelMin });
    alert("‚úÖ Item cadastrado com sucesso!");
    cadastroItemForm.reset();
  } catch (error) {
    console.error("Erro ao cadastrar item:", error);
    alert("‚ùå Erro ao cadastrar item.");
  }
});


// Criar Evento
eventoForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const nome = document.getElementById("boss-nome").value.trim();
  const horario = document.getElementById("evento-horario").value;
  const eventoRef = await addDoc(collection(db, "eventos"), { nome, horario, criadoEm: new Date() });
  eventoId = eventoRef.id;

  eventoNomeSpan.textContent = nome;
  eventoHorarioTexto.textContent = new Date(horario).toLocaleString();
  eventoBox.style.display = "block";

  fila = [];
  tabelaFila.innerHTML = "";
  historico.innerHTML = "";
  vencedorP.textContent = "";
});

// Adicionar √† Fila
filaForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const nick = document.getElementById("nick-fila").value.trim();
  const ordem = fila.length + 1;
  const jogador = { nick, ordem, faltas: 0 };
  fila.push(jogador);
  await setDoc(doc(db, `eventos/${eventoId}/fila`, nick), jogador);
  atualizarTabela();
  filaForm.reset();
});

// Atualizar Tabela
function atualizarTabela() {
  tabelaFila.innerHTML = "";
  fila.sort((a, b) => a.ordem - b.ordem);
  fila.forEach(jogador => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${jogador.ordem}</td><td>${jogador.nick}</td><td>${jogador.faltas}</td>`;
    tabelaFila.appendChild(tr);
  });
}

// Sorteio
sortearBtn.addEventListener("click", async () => {
  if (fila.length === 0) return alert("Fila vazia");
  const sorteado = fila[0];
  vencedorP.textContent = `Sorteado: ${sorteado.nick}`;

  await addDoc(collection(db, `eventos/${eventoId}/historico`), {
    nick: sorteado.nick, data: new Date()
  });

  historico.innerHTML += `<li>${sorteado.nick} - ${new Date().toLocaleString()}</li>`;
  sorteado.faltas += 1;

  if (sorteado.faltas >= 3) {
    fila.push(fila.shift());
    sorteado.ordem = fila.length;
  } else {
    fila[0] = sorteado;
  }

  await setDoc(doc(db, `eventos/${eventoId}/fila`, sorteado.nick), {
    faltas: sorteado.faltas, ordem: sorteado.ordem
  });

  atualizarTabela();
});

// Mostrar Itens Dispon√≠veis
async function mostrarItensElegiveis(nick, jogador) {
  const itensDiv = document.getElementById("itens-disponiveis");
  itensDiv.innerHTML = "";
  const itensSnap = await getDocs(collection(db, "itens"));
  let itemSelecionado = null;

  itensSnap.forEach(docSnap => {
    const item = docSnap.data();
    if (jogador.cp >= item.cpMin && jogador.nivel >= item.nivelMin) {
      const div = document.createElement("div");
      div.innerHTML = `
        <input type="radio" name="item" value="${docSnap.id}" />
        ${docSnap.id} (CP: ${formatarCP(item.cpMin)}, N√≠vel: ${item.nivelMin})
      `;
      itensDiv.appendChild(div);
    }
  });

  const radios = document.getElementsByName("item");
  radios.forEach(radio => {
    radio.addEventListener("change", () => {
      itemSelecionado = radio.value;
      document.getElementById("participar-btn").disabled = false;
    });
  });

  document.getElementById("participar-btn").onclick = async () => {
    if (!itemSelecionado) return;
    await addDoc(collection(db, "participacoes"), {
      nick: nick,
      item: itemSelecionado,
      data: new Date()
    });
    document.getElementById("mensagem-participacao").textContent =
      "Voc√™ est√° participando do sorteio. Aguarde o resultado!";
    document.getElementById("participar-btn").disabled = true;
  };
}

// Hist√≥rico do Jogador
async function carregarHistoricoJogador(nick) {
  const histUl = document.getElementById("historico-jogador");
  histUl.innerHTML = "";
  const eventosSnap = await getDocs(collection(db, "eventos"));
  for (const eventoDoc of eventosSnap.docs) {
    const histSnap = await getDocs(collection(db, `eventos/${eventoDoc.id}/historico`));
    histSnap.forEach(docSnap => {
      const data = docSnap.data();
      const li = document.createElement("li");
      li.textContent = `${data.nick} venceu em ${new Date(data.data.seconds * 1000).toLocaleString()}`;
      if (data.nick === nick) li.style.fontWeight = "bold";
      histUl.appendChild(li);
    });
  }
}

// Formatar CP
function formatarCP(valor) {
  if (valor >= 1e9) return (valor / 1e9).toFixed(1) + "B";
  if (valor >= 1e6) return (valor / 1e6).toFixed(1) + "M";
  return valor.toString();
}
</script>

</body>
</html>